{% extends 'base.html' %}

{% block title %}系统设置 - 股票分析系统{% endblock %}

{% block content %}
<div class="container my-4 fade-in">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="bi bi-gear me-2"></i>系统设置
                    </h4>
                </div>
                <div class="card-body">
                    {% if message %}
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    {% endif %}
                    
                    {% if error %}
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        {{ error }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    {% endif %}
                    
                    <!-- 选项卡导航 -->
                    <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="stocks-tab" data-bs-toggle="tab" data-bs-target="#stocks" type="button" role="tab" aria-controls="stocks" aria-selected="true">
                                <i class="bi bi-graph-up"></i> 股票管理
                            </button>
                        </li>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button" role="tab" aria-controls="data" aria-selected="false">
                                <i class="bi bi-database"></i> 数据采集
                            </button>
                        </li>
                    </ul>

                    <!-- 选项卡内容 -->
                    <div class="tab-content" id="settingsTabsContent">
                        <!-- 股票管理选项卡 -->
                        <div class="tab-pane fade show active" id="stocks" role="tabpanel" aria-labelledby="stocks-tab">
                            <div class="row mb-4">
                                <div class="col-lg-5">
                                    <div class="card shadow-sm">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0">添加新股票</h5>
                                        </div>
                                        <div class="card-body">
                                            <form method="post" action="{% url 'settings' %}">
                                                {% csrf_token %}
                                                <input type="hidden" name="action" value="add_stock">

                                                <div class="mb-3">
                                                    <label for="stock_code" class="form-label">股票代码</label>
                                                    <input type="text" class="form-control" id="stock_code" name="stock_code" placeholder="如: 600436" required>
                                                    <div class="form-text text-muted">请输入6位数字股票代码，无需前缀</div>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="stock_name" class="form-label">股票名称</label>
                                                    <input type="text" class="form-control" id="stock_name" name="stock_name" placeholder="如: 片仔癀" required>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="stock_industry" class="form-label">所属行业</label>
                                                    <input type="text" class="form-control" id="stock_industry" name="stock_industry" placeholder="如: 中药">
                                                    <div class="form-text text-muted">选填</div>
                                                </div>

                                                <button type="submit" class="btn btn-primary w-100">
                                                    <i class="bi bi-plus-circle me-2"></i>添加股票
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-lg-7">
                                    <div class="card shadow-sm">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0">当前股票列表</h5>
                                        </div>
                                        <div class="card-body p-0">
                                            <div class="alert alert-warning m-3">
                                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                                <strong>注意：</strong>删除股票将同时删除该股票的所有历史数据和实时数据表，此操作不可恢复。
                                            </div>
                                            <div class="table-responsive">
                                                <table class="table table-hover table-striped mb-0">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>股票代码</th>
                                                            <th>股票名称</th>
                                                            <th>所属行业</th>
                                                            <th>操作</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% if stocks %}
                                                            {% for stock in stocks %}
                                                            <tr>
                                                                <td>{{ stock.code }}</td>
                                                                <td>{{ stock.name }}</td>
                                                                <td>{{ stock.industry|default:"-" }}</td>
                                                                <td>
                                                                    <form method="post" action="{% url 'settings' %}" style="display: inline;">
                                                                        {% csrf_token %}
                                                                        <input type="hidden" name="action" value="delete_stock">
                                                                        <input type="hidden" name="stock_code" value="{{ stock.code }}">
                                                                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('确定要删除股票 {{ stock.name }}({{ stock.code }}) 吗？此操作将同时删除该股票的所有数据表！该操作不可恢复！')">
                                                                            <i class="bi bi-trash"></i>
                                                                        </button>
                                                                    </form>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        {% else %}
                                                            <tr>
                                                                <td colspan="4" class="text-center py-3">暂无股票数据</td>
                                                            </tr>
                                                        {% endif %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <!-- 数据采集选项卡 -->
                        <div class="tab-pane fade" id="data" role="tabpanel" aria-labelledby="data-tab">
                            <div class="card shadow-sm">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0">数据采集设置</h5>
                                </div>
                                <div class="card-body">
                                    <form method="post" action="{% url 'settings' %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="update_settings">

                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="realtime_interval" class="form-label">实时数据采集间隔(秒)</label>
                                                <input type="number" class="form-control" id="realtime_interval" name="realtime_interval" min="1" max="60" value="{{ settings.realtime_interval|default:'1' }}">
                                                <div class="form-text text-muted">设置过小可能会触发反爬机制</div>
                                            </div>
                                        </div>

                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-save me-2"></i>保存数据采集设置
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 激活Bootstrap选项卡
    document.addEventListener('DOMContentLoaded', function() {
        // 获取URL参数中的tab
        const urlParams = new URLSearchParams(window.location.search);
        const activeTab = urlParams.get('tab');

        if (activeTab) {
            // 激活对应的选项卡
            const tab = document.querySelector(`#${activeTab}-tab`);
            if (tab) {
                const bsTab = new bootstrap.Tab(tab);
                bsTab.show();
            }
        }

        // 添加点击事件，更新URL
        const tabs = document.querySelectorAll('[data-bs-toggle="tab"]');
        tabs.forEach(tab => {
            tab.addEventListener('shown.bs.tab', function(event) {
                const id = event.target.id.replace('-tab', '');
                const url = new URL(window.location);
                url.searchParams.set('tab', id);
                window.history.replaceState({}, '', url);
            });
        });
    });
</script>
{% endblock %} 